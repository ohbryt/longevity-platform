# 2026-02-08 (Sun) - Daily Automation + Mailing Fixes

## Goals
- Ensure the site updates daily with newly generated `ready_for_review` articles.
- Ensure the newsletter digest actually sends on schedule (cron + auth).

## What Was Broken
- **Content pipeline produced mostly `needs_revision` drafts**, so the website (which only shows `ready_for_review`) appeared not to update.
  - Causes observed in `automation/pipeline.log`: provider errors being saved as draft content, JSON parse failures, timeouts, and factual mismatches.
- **Digest cron requests were unauthorized** because the endpoint required `Authorization: Bearer CRON_SECRET`, but **Vercel Cron does not send that header by default**.

## Fixes Implemented

### 1) Automation Pipeline Reliability (`automation/`)
- `automation/content_pipeline.py`
  - Treat provider failures as errors (no more "API error" strings saved as content).
  - Treat invalid JSON outputs as failure and move on to the next paper.
  - Auto-revision loop: when fact-check flags issues, attempt conservative rewrite(s) and re-check.
  - Keep processing papers until enough `ready_for_review` drafts are produced:
    - `TARGET_READY_DRAFTS` (default `5`)
    - `MAX_PAPERS_TO_PROCESS` (default `15`)
    - `MAX_AUTO_REVISIONS` (default `2`)
  - Fact-check prompt now includes **full paper metadata** (authors/journal/pub_date/doi/url) to avoid false negatives.
  - Fact-check provider fallback on auth/timeout/parse errors.
- `automation/daily-pipeline.sh`
  - Optional Step 4: trigger digest after deploy when configured:
    - `TRIGGER_DIGEST=true`
    - `DIGEST_URL=https://longevity-lab.io/api/newsletter/send-digest`
    - `CRON_SECRET=...`

### 2) Mailing System Cron + Auth (`frontend/`)
- `frontend/src/app/api/newsletter/send-digest/route.ts`
  - Accept Vercel Cron by checking `x-vercel-cron: 1`.
  - Still supports manual trigger using `Authorization: Bearer CRON_SECRET`.
  - Send only newly generated **ready** articles from the last 24 hours (up to 5) to reduce repeat sends.
- `frontend/vercel.json`
  - Cron changed from weekly to **daily** (`0 22 * * *` UTC).

### 3) Gemini RAG Script Cleanup (root repo)
- Added `rag/.env.example.gemini` template and replaced broken bash scripts with runnable versions:
  - `setup-complete-gemini-rag.sh`
  - `start-gemini-rag.sh`
  - `rag/test-gemini-rag.sh`
- Kept secrets out of git by ignoring `rag/.env.gemini`.

## Verification
- Frontend build: `cd frontend && npm run build` (success).
- Deployed frontend to production via Vercel and updated alias to `longevity-lab.io`.
- Verified digest endpoint works with cron header:
  - `curl -H 'x-vercel-cron: 1' https://longevity-lab.io/api/newsletter/send-digest`
  - Returned: `Digest sent to 8 subscribers.`
- Verified `ohbryt@gmail.com` is already subscribed (`/api/newsletter` returned `409`).

## Git Activity
- Pushed `frontend` `main` to GitHub (now includes digest cron + auth fixes + Feb 8 content).
- Pushed root repo `master` to GitHub (now includes automation reliability improvements + submodule pointer updates).

## Notes / Config
- Ensure `automation/.env` has valid keys.
- Recommended:
  - `FACT_CHECK_PROVIDER=openai` (most stable) or `kimi` (lower cost) if the key is valid.
  - If using Kimi and seeing `401 Invalid Authentication`, switch fact-checking to OpenAI until the Kimi key is fixed.

