name: Daily Content Pipeline

on:
  schedule:
    # 매주 월요일 오전 9시 KST = 일요일 00:00 UTC
    - cron: '0 0 * * 1'
  workflow_dispatch: # 수동 실행 가능

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0  # Full history for gh-pages branch

      - name: Ensure gh-pages branch exists
        run: |
          if ! git ls-remote --heads origin gh-pages | grep -q gh-pages; then
            echo "Creating gh-pages branch..."
            git checkout --orphan gh-pages
            git rm -rf .
            echo "# GitHub Pages - Card News Images" > README.md
            git add README.md
            git commit -m "Initialize gh-pages branch"
            git push origin gh-pages
            git checkout -
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        run: pip install aiohttp google-genai python-dotenv pillow

      - name: Run content pipeline
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          INSTAGRAM_AUTO_POST: ${{ secrets.INSTAGRAM_AUTO_POST }}
          INSTAGRAM_USER_ID: ${{ secrets.INSTAGRAM_USER_ID }}
          INSTAGRAM_ACCESS_TOKEN: ${{ secrets.INSTAGRAM_ACCESS_TOKEN }}
          PAGES_BASE_URL: "https://chang-myungoh.github.io/longevity-platform"
          GITHUB_REPOSITORY: ${{ github.repository }}
          GIT_AUTHOR_NAME: "github-actions[bot]"
          GIT_AUTHOR_EMAIL: "github-actions[bot]@users.noreply.github.com"
          GIT_COMMITTER_NAME: "github-actions[bot]"
          GIT_COMMITTER_EMAIL: "github-actions[bot]@users.noreply.github.com"
        working-directory: automation
        run: python content_pipeline.py

      - name: Copy content to frontend
        run: |
          mkdir -p frontend/content
          cp automation/content_drafts/*.json frontend/content/ 2>/dev/null || true
          echo "Articles: $(ls frontend/content/*.json 2>/dev/null | wc -l)"

      - name: Upload card news images
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: card-news-${{ github.run_number }}
          path: automation/card_news/
          retention-days: 30
          if-no-files-found: ignore

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        working-directory: frontend
        run: |
          vercel pull --yes --environment=production --token=$VERCEL_TOKEN
          vercel build --prod --token=$VERCEL_TOKEN
          DEPLOY_URL=$(vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN 2>&1 | grep -o 'https://[^ ]*')
          echo "Deployed: $DEPLOY_URL"

      - name: Send weekly digest to subscribers
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          echo "Sending digest email to subscribers..."
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST "https://longevity-lab.io/api/newsletter/send-digest" \
            -H "Authorization: Bearer $CRON_SECRET")
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -1)
          echo "Status: $HTTP_CODE"
          echo "Response: $BODY"
          if [ "$HTTP_CODE" -ge 400 ]; then
            echo "Warning: Digest send returned $HTTP_CODE"
          fi
